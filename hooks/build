#!/usr/bin/env bash

set -x

baseImage="${DOCKER_TAG%%-*}"
releaseTag="${DOCKER_TAG#*-}"

case "$baseImage" in
  'alpine')
    baseBuilderImage="golang:alpine"
    baseImage="alpine"
    dockerfile="AlpineDockerfile"
  ;;
  'stretch')
    baseBuilderImage="golang:stretch"
    baseImage="debian:stretch-slim"
    dockerfile="DebianDockerfile"
  ;;
  *)
    echo "Invalid DOCKER_TAG '$DOCKER_TAG'.  Only alpine- and stretch- are supported."
    exit -1
  ;;
esac

docker build\
 --build-arg RELEASE_VERSION="$baseBuilderImage"\
 --build-arg BASE_IMAGE="$baseImage"\
 --build-arg RELEASE_TAG="$releaseTag"\
  -t "$IMAGE_NAME"\
  -f "$dockerfile" .
